<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Investra â€” Ã‰vÃ©nements</title>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root{
            --bg:#f6f8fc;--card:#fff;--text:#0f172a;--muted:#64748b;
            --border:rgba(15,23,42,.10);--shadow:0 14px 35px rgba(15,23,42,.08);
            --primary:#1d4ed8;--accent:#06b6d4;--success:#16a34a;
            --danger:#ef4444;--warning:#d97706;--radius:18px;--navy:#0b2a55;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

        /* â•â• NAVBAR â•â• */
        .navbar{position:sticky;top:0;z-index:200;background:#fff;border-bottom:1px solid rgba(15,23,42,.08);box-shadow:0 4px 16px rgba(15,23,42,.06)}
        .nav-inner{max-width:1120px;margin:0 auto;padding:0 16px;height:52px;display:flex;align-items:center;gap:0}
        .nav-brand{font-size:17px;font-weight:900;color:var(--navy);margin-right:32px;display:flex;align-items:center;gap:8px}
        .nav-brand span{color:var(--warning)}
        .nav-links{display:flex;gap:4px;flex:1}
        .nav-link{padding:6px 14px;border-radius:8px;font-size:13.5px;font-weight:700;color:var(--muted);cursor:pointer;text-decoration:none;transition:all .15s;border:none;background:none}
        .nav-link:hover{color:var(--primary);background:rgba(29,78,216,.06)}
        .nav-link.active{color:var(--primary);background:rgba(29,78,216,.08)}

        /* â•â• PAGE â•â• */
        .container{max-width:1120px;margin:28px auto 60px;padding:0 16px}
        .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
        .breadcrumb{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px}
        .breadcrumb strong{color:var(--text)}
        .actions{display:flex;gap:10px;flex-wrap:wrap}

        .btn{border:0;cursor:pointer;font-weight:800;font-size:14px;padding:10px 16px;border-radius:12px;display:inline-flex;align-items:center;gap:8px;transition:transform .15s,filter .15s}
        .btn.primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;box-shadow:0 10px 20px rgba(29,78,216,.18)}
        .btn.ghost  {background:#fff;border:1px solid var(--border);color:var(--text)}
        .btn.danger {background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#b91c1c}
        .btn.warning{background:rgba(217,119,6,.08);border:1px solid rgba(217,119,6,.2);color:#92400e}
        .btn.sm     {padding:7px 12px;font-size:12px;border-radius:9px}
        .btn.export {background:linear-gradient(135deg,#16a34a,#059669);color:#fff;box-shadow:0 8px 18px rgba(22,163,74,.22)}
        .btn.export:disabled{opacity:.6;cursor:not-allowed;filter:none;transform:none}
        .btn.export.loading::after{content:" â³"}
        .btn:hover  {filter:brightness(1.04)}


        .hero{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;overflow:hidden;position:relative;margin-bottom:22px}
        .hero::before{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(700px 220px at 12% 0%,rgba(29,78,216,.10),transparent 55%),radial-gradient(700px 260px at 98% 20%,rgba(6,182,212,.10),transparent 55%)}
        .hero-inner{position:relative;z-index:1}
        .badge{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid rgba(29,78,216,.18);background:rgba(29,78,216,.06);color:#0b2a55}
        .dot-b{width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 0 0 3px rgba(6,182,212,.14)}
        h1{margin:10px 0 6px;font-size:28px;font-weight:900}
        .pitch{margin:0;color:var(--muted);line-height:1.6;font-size:14.5px}

        .main-grid{display:grid;grid-template-columns:1fr 340px;gap:22px;align-items:start}
        @media(max-width:900px){.main-grid{grid-template-columns:1fr}}

        .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
        .card:last-child{margin-bottom:0}
        .section-title{margin:0 0 14px;font-size:17px;font-weight:900;display:flex;align-items:center;gap:8px}

        label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:#0b2a55;font-weight:900;margin:0 0 6px}
        .req{color:var(--danger)}
        input,select,textarea{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none;font-size:14px;color:var(--text);transition:border-color .15s,box-shadow .15s;font-family:inherit}
        textarea{min-height:90px;resize:vertical}
        input:focus,select:focus,textarea:focus{border-color:rgba(29,78,216,.35);box-shadow:0 0 0 4px rgba(29,78,216,.10)}
        /* âœ… CONTRÃ”LE DE SAISIE â€” styles visuels */
        input.field-error,textarea.field-error{border-color:rgba(239,68,68,.5)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
        input.field-ok{border-color:rgba(22,163,74,.4);box-shadow:0 0 0 3px rgba(22,163,74,.08)}
        .field-msg{font-size:11.5px;margin-top:5px;font-weight:700;display:none}
        .field-msg.err{color:var(--danger);display:block}
        .field-msg.ok {color:var(--success);display:block}

        .field{margin-bottom:13px}
        .field:last-child{margin-bottom:0}
        .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        @media(max-width:600px){.row2{grid-template-columns:1fr}}
        .hint{font-size:11.5px;color:var(--muted);margin-top:4px;line-height:1.4}

        .mode-toggle{display:flex;gap:8px}
        .mode-opt{flex:1;padding:10px;border-radius:12px;border:2px solid var(--border);background:#fff;color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s}
        .mode-opt:hover{border-color:rgba(29,78,216,.3);color:var(--primary)}
        .mode-opt.selected{border-color:var(--primary);background:rgba(29,78,216,.06);color:var(--primary)}

        .cond-field{overflow:hidden}
        .cond-field.hidden{max-height:0;opacity:0;margin-bottom:0!important;pointer-events:none}
        .cond-field.visible{max-height:200px;opacity:1}

        /* âœ… ALERT GLOBAL EN HAUT DU FORM */
        .form-alert{display:none;border-radius:12px;padding:11px 14px;font-size:13.5px;line-height:1.5;font-weight:700;margin-bottom:14px}
        .form-alert.error{border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.07);color:#7f1d1d;display:block}
        .form-alert.ok   {border:1px solid rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d;display:block}

        .summary{position:sticky;top:68px}
        .kpi-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
        .kpi{border:1px solid var(--border);border-radius:12px;background:#f8fafc;padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
        .kpi .klabel{font-size:12px;color:var(--muted);font-weight:700}
        .kpi .kval  {font-size:14px;font-weight:900;color:var(--text)}

        .list-header{display:flex;align-items:center;justify-content:space-between;margin:32px 0 16px}
        .list-header h2{margin:0;font-size:20px;font-weight:900}
        .count-badge{background:rgba(29,78,216,.08);border:1px solid rgba(29,78,216,.2);color:var(--primary);font-size:12px;font-weight:800;padding:3px 12px;border-radius:999px}
        .search-wrap{position:relative;margin-bottom:16px}
        .search-wrap input{padding-left:38px;border-radius:12px}
        .search-wrap::before{content:'ğŸ”';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none}

        .events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
        .ev-card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(15,23,42,.07);overflow:hidden;transition:box-shadow .2s,transform .2s}
        .ev-card:hover{box-shadow:0 12px 32px rgba(15,23,42,.12)}
        .ev-card-bar{height:5px}
        .ev-card-bar.online    {background:linear-gradient(90deg,var(--primary),var(--accent))}
        .ev-card-bar.presentiel{background:linear-gradient(90deg,var(--warning),#f59e0b)}
        .ev-card-body{padding:16px}
        .ev-mode-tag{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:800;padding:3px 10px;border-radius:999px;margin-bottom:10px}
        .ev-mode-tag.online    {background:rgba(29,78,216,.08);border:1px solid rgba(29,78,216,.2);color:var(--primary)}
        .ev-mode-tag.presentiel{background:rgba(217,119,6,.08); border:1px solid rgba(217,119,6,.2); color:var(--warning)}
        .ev-titre{font-size:15px;font-weight:900;margin:0 0 6px}
        .ev-desc {font-size:12.5px;color:var(--muted);margin:0 0 12px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .ev-meta{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
        .ev-meta-row{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--muted)}
        .ev-meta-row .ico{font-size:13px;flex-shrink:0}
        .ev-meta-row strong{color:var(--text);font-weight:700}
        .ev-divider{height:1px;background:var(--border);margin:0 0 12px}
        .ev-actions{display:flex;gap:8px}
        .ev-actions .btn{flex:1;justify-content:center}

        .empty-state{text-align:center;padding:50px 20px;color:var(--muted)}
        .empty-state .big-icon{font-size:48px;margin-bottom:14px}
        .empty-state p{font-size:15px;font-weight:600}
        .loading{text-align:center;padding:40px;color:var(--muted)}
        .spinner{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:10px}
        @keyframes spin{to{transform:rotate(360deg)}}

        .dialog-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:950;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .2s}
        .dialog-overlay.show{opacity:1;pointer-events:auto}
        .dialog{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(15,23,42,.2);transform:scale(.94);transition:transform .2s;text-align:center}
        .dialog-overlay.show .dialog{transform:scale(1)}
        .dialog .d-icon{font-size:44px;margin-bottom:12px}
        .dialog h3{margin:0 0 8px;font-size:17px;font-weight:900}
        .dialog p{margin:0 0 22px;color:var(--muted);font-size:14px;line-height:1.5}
        .dialog-btns{display:flex;gap:10px;justify-content:center}

        #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(70px);z-index:999;min-width:260px;max-width:420px;background:#1e293b;border-radius:12px;padding:13px 18px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 36px rgba(0,0,0,.3);transition:transform .32s cubic-bezier(.34,1.56,.64,1),opacity .25s;opacity:0;font-size:14px;color:#fff;pointer-events:none}
        #toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        #toast.success{border-left:4px solid var(--success)}
        #toast.error  {border-left:4px solid var(--danger)}

        /* â•â• MAP â•â• */
        .ev-map-wrap{margin:10px 0 8px;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
        .ev-map{height:160px;width:100%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px}
        .ev-map-loading{display:flex;align-items:center;justify-content:center;gap:8px;height:160px;color:var(--muted);font-size:13px;background:#f8fafc}
        .btn-itineraire{width:100%;margin-top:6px;justify-content:center;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);color:#0369a1;border-radius:10px;padding:7px;font-size:12px;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
        .btn-itineraire:hover{background:rgba(6,182,212,.15);transform:translateY(-1px)}
    </style>
</head>
<body>

<!-- â•â• NAVBAR â•â• -->
<nav class="navbar">
    <div class="nav-inner">
        <div class="nav-brand">ğŸ“… Invest<span>ia</span></div>
        <div class="nav-links">
            <a class="nav-link active">ğŸ“‹ Ã‰vÃ©nements</a>
            <a class="nav-link" onclick="goInvitations()">âœ‰ï¸ Invitations</a>
            <a class="nav-link" onclick="goChatbot()">ğŸ¤– Assistant IA</a>
        </div>
    </div>
</nav>

<main class="container">

    <div class="topbar">
        <div class="breadcrumb"><span>Ã‰vÃ©nements</span><span>â€¢</span><strong>GÃ©rer</strong></div>
        <div class="actions">
            <button class="btn export" id="btnExport" onclick="exportPdf()">ğŸ“„ Exporter PDF</button>
            <button class="btn ghost" onclick="resetForm()">RÃ©initialiser</button>
            <button class="btn primary" onclick="submitForm()">ğŸ’¾ Enregistrer</button>
        </div>
    </div>

    <section class="hero">
        <div class="hero-inner">
            <span class="badge"><span class="dot-b"></span>Gestion des Ã©vÃ©nements</span>
            <h1>Ã‰vÃ©nements</h1>
            <p class="pitch">CrÃ©ez et gÃ©rez les Ã©vÃ©nements. Les champs <span style="color:var(--danger)">*</span> sont obligatoires.</p>
        </div>
    </section>

    <div class="main-grid">
        <div>
            <!-- ALERT GLOBAL -->
            <div class="form-alert" id="globalAlert"></div>

            <section class="card">
                <h2 class="section-title">ğŸ“‹ Informations gÃ©nÃ©rales</h2>
                <div class="field">
                    <label for="titre">Titre <span class="req">*</span></label>
                    <input id="titre" type="text" placeholder="Ex : Workshop IA" maxlength="120"
                           oninput="validateField('titre')" onblur="validateField('titre')"/>
                    <div class="field-msg" id="msg_titre"></div>
                </div>
                <div class="row2">
                    <div class="field">
                        <label for="projectId">Project ID <span class="req">*</span></label>
                        <input id="projectId" type="number" min="1" placeholder="5"
                               oninput="validateField('projectId')" onblur="validateField('projectId')"/>
                        <div class="field-msg" id="msg_projectId"></div>
                    </div>
                    <div class="field">
                        <label for="organisateurId">Organisateur ID <span class="req">*</span></label>
                        <input id="organisateurId" type="number" min="1" placeholder="12"
                               oninput="validateField('organisateurId')" onblur="validateField('organisateurId')"/>
                        <div class="field-msg" id="msg_organisateurId"></div>
                    </div>
                </div>
                <div class="field">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="DÃ©crivez l'Ã©vÃ©nementâ€¦"
                              oninput="validateField('description')"></textarea>
                    <div class="field-msg" id="msg_description"></div>
                </div>
            </section>

            <section class="card">
                <h2 class="section-title">ğŸ“ Mode & Localisation</h2>
                <div class="field">
                    <label>Mode <span class="req">*</span></label>
                    <div class="mode-toggle">
                        <div class="mode-opt selected" id="optEL" onclick="setMode('EN_LIGNE')">ğŸŒ En ligne</div>
                        <div class="mode-opt"          id="optPR" onclick="setMode('PRESENTIEL')">ğŸ¢ PrÃ©sentiel</div>
                    </div>
                    <input type="hidden" id="mode" value="EN_LIGNE"/>
                </div>
                <div class="cond-field visible" id="condLien" style="margin-top:12px">
                    <div class="field">
                        <label for="meetingLink">Lien de rÃ©union</label>
                        <input id="meetingLink" type="text" placeholder="https://meet.google.com/â€¦"
                               oninput="validateField('meetingLink')" onblur="validateField('meetingLink')"/>
                        <div class="field-msg" id="msg_meetingLink"></div>
                    </div>
                </div>
                <div class="cond-field hidden" id="condLieu" style="margin-top:12px">
                    <div class="field">
                        <label for="lieu">Lieu <span class="req">*</span></label>
                        <input id="lieu" type="text" placeholder="Salle A12â€¦"
                               oninput="validateField('lieu')" onblur="validateField('lieu')"/>
                        <div class="field-msg" id="msg_lieu"></div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2 class="section-title">ğŸ“… Dates & Horaires</h2>
                <div class="row2">
                    <div class="field">
                        <label for="dateDebut">Date dÃ©but <span class="req">*</span></label>
                        <input id="dateDebut" type="datetime-local"
                               onchange="validateDates()"/>
                        <div class="field-msg" id="msg_dateDebut"></div>
                    </div>
                    <div class="field">
                        <label for="dateFin">Date fin <span class="req">*</span></label>
                        <input id="dateFin" type="datetime-local"
                               onchange="validateDates()"/>
                        <div class="field-msg" id="msg_dateFin"></div>
                    </div>
                </div>
                <p class="hint">âš ï¸ La date de fin doit Ãªtre postÃ©rieure Ã  la date de dÃ©but.</p>
            </section>

            <div class="actions" style="margin-top:16px">
                <button class="btn ghost"   onclick="resetForm()">RÃ©initialiser</button>
                <button class="btn primary" onclick="submitForm()">ğŸ’¾ Enregistrer</button>
            </div>
        </div>

        <aside class="summary">
            <section class="card">
                <h2 class="section-title">ğŸ‘ï¸ AperÃ§u</h2>
                <div class="kpi-list">
                    <div class="kpi"><span class="klabel">Titre</span> <span class="kval" id="kTitre">â€”</span></div>
                    <div class="kpi"><span class="klabel">Mode</span>  <span class="kval" id="kMode">EN_LIGNE</span></div>
                    <div class="kpi"><span class="klabel">DÃ©but</span> <span class="kval" id="kDebut">â€”</span></div>
                    <div class="kpi"><span class="klabel">Fin</span>   <span class="kval" id="kFin">â€”</span></div>
                    <div class="kpi"><span class="klabel">DurÃ©e</span> <span class="kval" id="kDuree">â€”</span></div>
                </div>
            </section>
            <section class="card">
                <h2 class="section-title" style="font-size:14px">â„¹ï¸ Rappel</h2>
                <p style="font-size:13px;color:var(--muted);margin:0;line-height:1.6">L'Ã©vÃ©nement sera soumis Ã  validation par un administrateur.</p>
            </section>
        </aside>
    </div>

    <!-- LISTE -->
    <div class="list-header">
        <h2>ğŸ“‹ Tous les Ã©vÃ©nements <span class="count-badge" id="countBadge">0</span></h2>
    </div>
    <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="Rechercherâ€¦" oninput="filterCards()"/>
    </div>
    <div class="loading"     id="stateLoad"><div class="spinner"></div><p>Chargementâ€¦</p></div>
    <div class="empty-state" id="stateEmpty" style="display:none"><div class="big-icon">ğŸ“­</div><p>Aucun Ã©vÃ©nement</p></div>
    <div class="events-grid" id="eventsGrid" style="display:none"></div>
</main>

<!-- DIALOG SUPPRESSION -->
<div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog">
        <div class="d-icon">ğŸ—‘ï¸</div>
        <h3>Confirmer la suppression</h3>
        <p id="dialogMsg">Voulez-vous vraiment supprimer cet Ã©vÃ©nement ?</p>
        <div class="dialog-btns">
            <button class="btn ghost"  onclick="closeDialog()">Annuler</button>
            <button class="btn danger" onclick="confirmSupprimer()">Supprimer</button>
        </div>
    </div>
</div>

<div id="toast"><span id="toastMsg"></span></div>

<script>
    var allEvents    = [];
    var pendingDelId = null;

    // â•â• NAVIGATION â•â•
    function goChatbot() {
        withBridge(function(b){ b.goChatbot(); });
    }

    function goInvitations() {
        if (window.javaBridge && typeof window.javaBridge.goInvitations === 'function') {
            window.javaBridge.goInvitations();
        }
    }

    // â•â• BRIDGE â•â•
    function withBridge(onReady, onFail) {
        var start = Date.now();
        var t = setInterval(function() {
            if (window.javaBridge) { clearInterval(t); onReady(window.javaBridge); return; }
            if (Date.now()-start > 3000) { clearInterval(t); if(onFail) onFail(); }
        }, 80);
    }

    // â•â• RENDER â•â•
    function renderTable(data) {
        if (typeof data === 'string') { try { data = JSON.parse(data); } catch(e){ data=[]; } }
        allEvents = data;
        renderCards(data);
    }

    function renderCards(data) {
        var grid = g('eventsGrid'), empty = g('stateEmpty');
        g('stateLoad').style.display='none';
        g('countBadge').textContent=data.length;
        if (!data||data.length===0) { empty.style.display='block'; grid.style.display='none'; return; }
        empty.style.display='none'; grid.style.display='grid';
        var html='';
        for (var i=0;i<data.length;i++) {
            var ev=data[i], isO=ev.mode==='EN_LIGNE';
            var mc=isO?'online':'presentiel', ml=isO?'ğŸŒ En ligne':'ğŸ¢ PrÃ©sentiel';
            var det=isO?(ev.meetingLink||'â€”'):(ev.lieu||'â€”'), ico=isO?'ğŸ”—':'ğŸ“';
            var idx=i;
            html+='<div class="ev-card">'
                +'<div class="ev-card-bar '+mc+'"></div>'
                +'<div class="ev-card-body">'
                +'<span class="ev-mode-tag '+mc+'">'+ml+'</span>'
                +'<p class="ev-titre">'+esc(ev.titre)+'</p>'
                +'<p class="ev-desc">'+(ev.description?esc(ev.description):'<em>Aucune description</em>')+'</p>'
                +'<div class="ev-meta">'
                +'<div class="ev-meta-row"><span class="ico">ğŸ“…</span><span>DÃ©but : <strong>'+fmtDate(ev.dateDebut)+'</strong></span></div>'
                +'<div class="ev-meta-row"><span class="ico">ğŸ</span><span>Fin : <strong>'+fmtDate(ev.dateFin)+'</strong></span></div>'
                +'<div class="ev-meta-row"><span class="ico">'+ico+'</span><span>'+esc(det)+'</span></div>'
                +'<div class="ev-meta-row"><span class="ico">ğŸ†”</span><span>Projet : <strong>#'+ev.projectId+'</strong></span></div>'
                +'</div>'
                // âœ… MAP uniquement pour PRÃ‰SENTIEL
                +(!isO && ev.lieu ? buildMapBlock(ev.id, ev.lieu) : '')
                +'<div class="ev-divider"></div>'
                +'<div class="ev-actions">'
                +'<button class="btn warning sm" onclick="openModifierWindow('+idx+')">âœï¸ Modifier</button>'
                +'<button class="btn danger  sm" onclick="openSupprimer('+idx+')">ğŸ—‘ï¸ Supprimer</button>'
                +'</div>'
                +'</div>'
                +'</div>';
        }
        g('eventsGrid').innerHTML=html;
        // Charger les cartes aprÃ¨s rendu HTML
        setTimeout(initMaps, 100);
    }

    // â•â• CONTRÃ”LE DE SAISIE PAR CHAMP â•â•
    var fieldRules = {
        titre:          { required:true,  minLen:3, maxLen:120, label:'Titre' },
        projectId:      { required:true,  isInt:true, min:1,   label:'Project ID' },
        organisateurId: { required:true,  isInt:true, min:1,   label:'Organisateur ID' },
        description:    { required:false, maxLen:500,           label:'Description' },
        meetingLink:    { required:false, isUrl:true,           label:'Lien de rÃ©union' },
        lieu:           { required:false,                       label:'Lieu' }
    };

    function validateField(id) {
        var el   = g(id);
        var msg  = g('msg_'+id);
        if (!el || !msg) return true;
        var val  = (el.value||'').trim();
        var rule = fieldRules[id];
        if (!rule) return true;
        var mode = g('mode').value;

        // âœ… meetingLink obligatoire si EN_LIGNE, lieu obligatoire si PRESENTIEL
        if (id === 'meetingLink') rule.required = (mode === 'EN_LIGNE');
        if (id === 'lieu')        rule.required = (mode === 'PRESENTIEL');

        if (rule.required && !val) {
            setFieldState(el, msg, false, 'âš ï¸ ' + rule.label + ' est obligatoire.');
            return false;
        }
        if (!val) { clearFieldState(el, msg); return true; }

        if (rule.isInt) {
            var n = parseInt(val);
            if (isNaN(n) || n < (rule.min||1)) {
                setFieldState(el, msg, false, 'âš ï¸ ' + rule.label + ' doit Ãªtre un entier >= '+(rule.min||1)+'.');
                return false;
            }
        }
        if (rule.minLen && val.length < rule.minLen) {
            setFieldState(el, msg, false, 'âš ï¸ Minimum ' + rule.minLen + ' caracteres.');
            return false;
        }
        if (rule.maxLen && val.length > rule.maxLen) {
            setFieldState(el, msg, false, 'âš ï¸ Maximum ' + rule.maxLen + ' caracteres.');
            return false;
        }
        if (rule.isUrl && !val.match(/^https?:\/\/.+/)) {
            setFieldState(el, msg, false, 'âš ï¸ Doit commencer par http:// ou https://');
            return false;
        }
        setFieldState(el, msg, true, 'âœ“');
        return true;
    }

    function validateDates() {
        var dd = g('dateDebut').value, df = g('dateFin').value;
        var msgD = g('msg_dateDebut'), msgF = g('msg_dateFin');
        var ok = true;
        if (!dd) { setFieldState(g('dateDebut'),msgD,false,'Date de dÃ©but obligatoire.'); ok=false; }
        else clearFieldState(g('dateDebut'),msgD);
        if (!df) { setFieldState(g('dateFin'),msgF,false,'Date de fin obligatoire.'); ok=false; }
        else if (dd && new Date(df)<=new Date(dd)) {
            setFieldState(g('dateFin'),msgF,false,'La date de fin doit Ãªtre aprÃ¨s la date de dÃ©but.');
            ok=false;
        } else clearFieldState(g('dateFin'),msgF);
        refreshPreview();
        return ok;
    }

    function setFieldState(el, msgEl, isOk, text) {
        el.classList.toggle('field-ok',    isOk);
        el.classList.toggle('field-error', !isOk);
        msgEl.textContent = text;
        msgEl.className   = 'field-msg '+(isOk?'ok':'err');
    }
    function clearFieldState(el, msgEl) {
        el.classList.remove('field-ok','field-error');
        msgEl.className='field-msg'; msgEl.textContent='';
    }

    function validateAll() {
        var ok = true;
        // Champs communs
        ['titre','projectId','organisateurId','description'].forEach(function(id){
            if (!validateField(id)) ok = false;
        });
        // âœ… meetingLink obligatoire si EN_LIGNE, sinon ignorÃ©
        // âœ… lieu obligatoire si PRESENTIEL, sinon ignorÃ©
        if (!validateField('meetingLink')) ok = false;
        if (!validateField('lieu'))        ok = false;
        if (!validateDates()) ok = false;
        return ok;
    }

    // â•â• SUBMIT â•â•
    function submitForm() {
        var alertEl = g('globalAlert');
        alertEl.className='form-alert'; alertEl.textContent='';

        if (!validateAll()) {
            alertEl.className='form-alert error';
            alertEl.textContent='âš ï¸ Veuillez corriger les champs en rouge avant d\'enregistrer.';
            alertEl.scrollIntoView({behavior:'smooth',block:'center'});
            return;
        }

        withBridge(function(b) {
            if (typeof b.ajouter !== 'function') { alertEl.className='form-alert error'; alertEl.textContent='Bridge.ajouter introuvable.'; return; }
            var r = b.ajouter(
                g('titre').value.trim(), parseInt(g('projectId').value),
                g('description').value.trim(), g('mode').value,
                fmtJava(g('dateDebut').value), fmtJava(g('dateFin').value),
                g('lieu').value.trim(), g('meetingLink').value.trim(),
                parseInt(g('organisateurId').value)
            );
            if (r==='OK'||(r&&r.startsWith('OK'))) {
                alertEl.className='form-alert ok'; alertEl.textContent='âœ… Ã‰vÃ©nement enregistrÃ© avec succÃ¨s !';
                resetForm(); reloadList();
            } else {
                alertEl.className='form-alert error'; alertEl.textContent='âŒ Erreur : '+(r||'Inconnue');
            }
        }, function(){ alertEl.className='form-alert error'; alertEl.textContent='Bridge Java indisponible.'; });
    }

    // â•â• SUPPRIMER â•â•
    function openSupprimer(idx) {
        var ev=allEvents[idx]; if(!ev) return;
        pendingDelId=ev.id;
        g('dialogMsg').textContent='Supprimer Â« '+ev.titre+' Â» ? Cette action est irrÃ©versible.';
        g('dialogOverlay').classList.add('show');
    }
    function closeDialog(){ g('dialogOverlay').classList.remove('show'); }
    function confirmSupprimer(){
        closeDialog();
        withBridge(function(b){
            var r=b.supprimer(pendingDelId);
            if(r==='OK'||(r&&r.startsWith('OK'))){ toast('ğŸ—‘ï¸ SupprimÃ©.','success'); reloadList(); }
            else toast('âŒ '+(r||'Erreur'),'error');
        },function(){ toast('Bridge indisponible.','error'); });
    }

    // â•â• MODIFIER (ouvre fenÃªtre sÃ©parÃ©e) â•â•
    function openModifierWindow(idx) {
        var ev=allEvents[idx]; if(!ev) return;
        if(window.javaBridge && typeof window.javaBridge.openModifierWindow==='function'){
            window.javaBridge.openModifierWindow(
                ev.id,ev.titre,ev.projectId,ev.organisateurId,
                ev.description||'',ev.mode,
                ev.dateDebut||'',ev.dateFin||'',
                ev.lieu||'',ev.meetingLink||''
            );
        }
    }

    // â•â• RELOAD â•â•
    function reloadList(){
        withBridge(function(b){ renderTable(b.getAll()); },function(){});
    }

    // â•â• RECHERCHE â•â•
    function filterCards(){
        var q=g('searchInput').value.toLowerCase();
        if(!q){ renderCards(allEvents); return; }
        var f=allEvents.filter(function(ev){
            return (ev.titre||'').toLowerCase().indexOf(q)>=0
                || (ev.description||'').toLowerCase().indexOf(q)>=0
                || (ev.mode||'').toLowerCase().indexOf(q)>=0
                || (ev.lieu||'').toLowerCase().indexOf(q)>=0;
        });
        renderCards(f);
    }

    // â•â• MODE TOGGLE â•â•
    function setMode(m){
        g('mode').value=m;
        g('optEL').classList.toggle('selected',m==='EN_LIGNE');
        g('optPR').classList.toggle('selected',m==='PRESENTIEL');
        g('condLien').className='cond-field '+(m==='EN_LIGNE'  ?'visible':'hidden');
        g('condLieu').className='cond-field '+(m==='PRESENTIEL'?'visible':'hidden');
        g('kMode').textContent=m;
        // âœ… Re-valider meetingLink et lieu selon le mode
        // Chaque champ recalcule lui-mÃªme s'il est obligatoire selon le mode actuel
        validateField('meetingLink');
        validateField('lieu');
    }

    // â•â• RESET â•â•
    function resetForm(){
        ['titre','projectId','organisateurId','description','meetingLink','lieu','dateDebut','dateFin']
            .forEach(function(id){ g(id).value=''; clearFieldState(g(id),g('msg_'+id)); });
        setMode('EN_LIGNE');
        g('globalAlert').className='form-alert'; g('globalAlert').textContent='';
        refreshPreview();
    }

    // â•â• APERÃ‡U â•â•
    function refreshPreview(){
        g('kTitre').textContent=g('titre').value.trim()||'â€”';
        var dd=g('dateDebut').value, df=g('dateFin').value;
        g('kDebut').textContent=dd?fmtDisplay(dd):'â€”';
        g('kFin').textContent  =df?fmtDisplay(df):'â€”';
        if(dd&&df){ var diff=new Date(df)-new Date(dd);
            g('kDuree').textContent=diff>0?Math.floor(diff/3600000)+'h'+Math.floor((diff%3600000)/60000)+'min':'âš ï¸ invalide';
        } else g('kDuree').textContent='â€”';
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GOOGLE MAPS â€” Leaflet + OpenStreetMap
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    var mapInstances = {}; // stocke les instances Leaflet pour Ã©viter doublons

    function buildMapBlock(evId, lieu) {
        return '<div class="ev-map-wrap">'
            +'<div class="ev-map-loading" id="mapLoading_'+evId+'">ğŸ—ºï¸ Chargement de la carteâ€¦</div>'
            +'<div id="map_'+evId+'" style="height:160px;width:100%;display:none;border-radius:12px"></div>'
            +'</div>'
            +'<a class="btn-itineraire" id="itineraire_'+evId+'" href="#" target="_blank" style="display:none">'
            +'ğŸ§­ Voir l itinÃ©raire</a>';
    }

    function initMaps() {
        var cards = document.querySelectorAll('[id^="mapLoading_"]');
        cards.forEach(function(el) {
            var evId = el.id.replace('mapLoading_', '');
            if (mapInstances[evId]) return; // dÃ©jÃ  chargÃ©
            // Trouver le lieu de l'Ã©vÃ©nement
            var ev = allEvents.find(function(e){ return String(e.id) === String(evId); });
            if (!ev || !ev.lieu) return;
            geocodeAndShow(evId, ev.lieu);
        });
    }

    function geocodeAndShow(evId, lieu) {
        var url = 'https://nominatim.openstreetmap.org/search?format=json&q='
            + encodeURIComponent(lieu + ', Tunisie') + '&limit=1';

        fetch(url, { headers: { 'Accept-Language': 'fr' } })
            .then(function(r){ return r.json(); })
            .then(function(data) {
                var loadEl = document.getElementById('mapLoading_' + evId);
                var mapEl  = document.getElementById('map_' + evId);
                var btnEl  = document.getElementById('itineraire_' + evId);

                if (!data || data.length === 0) {
                    if (loadEl) loadEl.innerHTML = 'ğŸ“ Carte indisponible pour ce lieu';
                    return;
                }

                var lat = parseFloat(data[0].lat);
                var lng = parseFloat(data[0].lon);

                // Cacher loading, afficher map
                if (loadEl) loadEl.style.display = 'none';
                if (mapEl)  mapEl.style.display  = 'block';

                // CrÃ©er carte Leaflet
                var map = L.map('map_' + evId, {
                    center: [lat, lng],
                    zoom: 15,
                    zoomControl: true,
                    scrollWheelZoom: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19
                }).addTo(map);

                // Marker personnalisÃ©
                var icon = L.divIcon({
                    html: '<div style="background:linear-gradient(135deg,#1d4ed8,#06b6d4);width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid #fff;box-shadow:0 4px 12px rgba(29,78,216,.4)"></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    className: ''
                });

                L.marker([lat, lng], { icon: icon })
                    .addTo(map)
                    .bindPopup('<strong>ğŸ“ ' + lieu + '</strong>')
                    .openPopup();

                mapInstances[evId] = map;

                // Bouton itinÃ©raire
                if (btnEl) {
                    btnEl.href = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng;
                    btnEl.style.display = 'flex';
                }
            })
            .catch(function(err) {
                var loadEl = document.getElementById('mapLoading_' + evId);
                if (loadEl) loadEl.innerHTML = 'âš ï¸ Impossible de charger la carte';
            });
    }

    // â•â• UTILS â•â•
    function g(id){ return document.getElementById(id); }
    function fmtJava(s){ if(!s)return''; var p=s.split('T'); return p[0]+' '+((p[1]||'00:00').substring(0,5))+':00'; }
    function fmtDate(s){ if(!s)return'â€”'; try{ var d=new Date(s.replace(' ','T')); return d.toLocaleDateString('fr-FR')+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}); }catch(e){return s;} }
    function fmtDisplay(s){ if(!s)return'â€”'; var p=s.split('T'),d=p[0].split('-'); return d[2]+'/'+d[1]+'/'+d[0]+' '+(p[1]?p[1].substring(0,5):''); }
    function esc(s){ if(!s)return''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    var _tt;
    function toast(msg,type){ var t=g('toast'); g('toastMsg').textContent=msg; t.className='show '+(type||'success'); clearTimeout(_tt); _tt=setTimeout(function(){ t.className=type||'success'; },3500); }

    g('dialogOverlay').addEventListener('click',function(e){ if(e.target===this) closeDialog(); });
    g('titre').addEventListener('input', refreshPreview);
    g('dateDebut').addEventListener('change', refreshPreview);
    g('dateFin').addEventListener('change', refreshPreview);
    refreshPreview();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  EXPORT PDF
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportPdf() {
        var btn = g('btnExport');
        if (!window.javaBridge || typeof window.javaBridge.exportPdf !== 'function') {
            toast('âš ï¸ Bridge indisponible', 'error'); return;
        }
        btn.disabled = true;
        btn.classList.add('loading');
        btn.textContent = 'â³ GÃ©nÃ©rationâ€¦';
        window.javaBridge.exportPdf();
    }

    // AppelÃ© par Java aprÃ¨s gÃ©nÃ©ration
    function onPdfExported(status, info) {
        var btn = g('btnExport');
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'ğŸ“„ Exporter PDF';
        if (status === 'OK') {
            toast('âœ… PDF exportÃ© avec succÃ¨s !', 'success');
        } else {
            toast('âŒ Erreur : ' + info, 'error');
        }
    }

</script>
</body>
</html>